deploy:
  image: gcr.io/bazel-public/bazel:latest
  commands:
  - name: build image with bazel and deploy app
    command: |
      set -xe
      if [ -n "$REMOTE_CACHE" ]; then
        bazel run --remote_cache="$REMOTE_CACHE" //:push -- --repository "${IMAGE_REPOSITORY}" --tag "${IMAGE_TAG}"
      else
        bazel run //:push -- --repository "${IMAGE_REPOSITORY}" --tag "${IMAGE_TAG}"
      fi
      export HELLO_WORLD_IMAGE="${IMAGE_REPOSITORY}:${IMAGE_TAG}"
      okteto deploy -f docker-compose.yaml
      

dev:
  hello-world:
    image: okteto/golang:1
    command: bash
    sync:
      - .:/usr/src/app
    volumes:
      - /go
      - /root/.cache
    securityContext:
      capabilities:
        add:
          - SYS_PTRACE
    forward:
      - 2345:2345
